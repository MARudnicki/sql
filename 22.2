CREATE PROCEDURE UpdateBestsellers(last_month INT)
  BEGIN
    DECLARE TIMESRENTED, BK_ID INT;
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE ALL_FREQUENTLY CURSOR FOR SELECT BOOK_ID FROM RENTS;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
    OPEN ALL_FREQUENTLY;
    WHILE (FINISHED = 0) DO
      FETCH ALL_FREQUENTLY INTO BK_ID;
      IF (FINISHED = 0) THEN
        SELECT COUNT(*) FROM RENTS
        WHERE BOOK_ID = BK_ID
              AND MONTH(RENTS.RENT_DATE) = last_month
        INTO TIMESRENTED;

        IF TIMESRENTED > 2 THEN
          UPDATE BOOKS SET BESTSELLER = 'true';
        ELSE
          UPDATE BOOKS SET BESTSELLER = 'false';
        END IF;
      END IF;
    END WHILE;
    CLOSE ALL_FREQUENTLY;
  END
